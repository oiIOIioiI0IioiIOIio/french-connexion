<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>French Connexion</title>
  
  <!-- 1. Framework CSS Moderne (Tailwind) -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. Vue.js 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  
  <!-- 3. Marked pour le Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- Configuration Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#2c3e50',
            secondary: '#42b983',
            background: '#f8fafc',
            surface: '#ffffff'
          }
        }
      }
    }
  </script>
  
  <style>
    /* Styles Markdown */
    .markdown-body h1 { font-size: 1.8em; font-weight: bold; margin-bottom: 0.5em; color: #1a202c; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.3em; }
    .markdown-body h2 { font-size: 1.5em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #2d3748; }
    .markdown-body h3 { font-size: 1.25em; font-weight: bold; margin-top: 0.8em; margin-bottom: 0.4em; color: #2d3748; }
    .markdown-body p { margin-bottom: 1em; line-height: 1.6; color: #4a5568; }
    .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
    .markdown-body li { margin-bottom: 0.3em; }
    .markdown-body a { color: #3182ce; text-decoration: underline; }
    
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #42b983; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .keyword-tag { display: inline-block; padding: 0.25rem 0.5rem; margin: 0.125rem; font-size: 0.75rem; border-radius: 0.375rem; background-color: #e2e8f0; color: #4a5568; }
    .connection-link { color: #3182ce; cursor: pointer; text-decoration: underline; }
    .connection-link:hover { color: #2c5aa0; }
  </style>
</head>
<body class="bg-background text-slate-800 h-screen overflow-hidden">

  <div id="app" class="flex h-full">
    
    <!-- SIDEBAR -->
    <aside class="w-64 bg-surface border-r border-gray-200 flex flex-col shadow-sm z-10">
      <div class="p-6 border-b border-gray-100">
        <h1 class="text-2xl font-bold text-primary">French Connexion</h1>
        <p class="text-xs text-gray-500 mt-1">Base de donn√©es interactive</p>
      </div>

      <nav class="flex-1 overflow-y-auto p-4 space-y-2">
        <button @click="loadFolder(null)" :class="{'bg-primary text-white': !selectedFolder, 'text-gray-600 hover:bg-gray-100': selectedFolder}" class="w-full text-left px-4 py-2 rounded-lg transition-colors font-medium">
          üìÇ Toutes les fiches
        </button>
        
        <div v-for="folder in folders" :key="folder">
          <button @click="loadFolder(folder)" :class="{'bg-primary text-white': selectedFolder === folder, 'text-gray-600 hover:bg-gray-100': selectedFolder !== folder}" class="w-full text-left px-4 py-2 rounded-lg transition-colors text-sm capitalize">
            {{ formatFolderName(folder) }}
          </button>
        </div>
      </nav>
      
      <div class="p-4 border-t border-gray-100 text-xs text-center text-gray-400">
        Powered by GitHub Raw Content
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
      
      <!-- Header / Search / Filters -->
      <header class="bg-surface border-b border-gray-200 shadow-sm">
        <div class="flex items-center justify-between px-8 py-4">
          <h2 class="text-lg font-semibold text-gray-700">
            {{ selectedFolder ? formatFolderName(selectedFolder) : 'Vue d\'ensemble' }} 
            <span class="text-sm font-normal text-gray-400 ml-2">({{ filteredFiles.length }} fiches)</span>
          </h2>
          
          <div class="flex items-center gap-4">
            <div class="relative w-64">
              <input v-model="searchQuery" type="text" placeholder="Rechercher..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent text-sm">
              <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
            </div>
          </div>
        </div>
        
        <div class="flex items-center justify-between px-8 pb-3 gap-4">
          <div class="flex items-center gap-4">
            <label class="text-sm font-medium text-gray-600">Trier par:</label>
            <select v-model="sortBy" class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary bg-white">
              <option value="name">Nom (A-Z)</option>
              <option value="name-desc">Nom (Z-A)</option>
              <option value="type">Type</option>
              <option value="date">Date</option>
            </select>
          </div>
          
          <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-gray-600">Affichage:</label>
            <button @click="showMetadata = !showMetadata" :class="{'bg-primary text-white': showMetadata, 'bg-gray-200 text-gray-600': !showMetadata}" class="px-3 py-1.5 text-sm rounded-lg transition-colors">
              {{ showMetadata ? 'M√©tadonn√©es ‚úì' : 'M√©tadonn√©es' }}
            </button>
            <button @click="showConnections = !showConnections" :class="{'bg-primary text-white': showConnections, 'bg-gray-200 text-gray-600': !showConnections}" class="px-3 py-1.5 text-sm rounded-lg transition-colors">
              {{ showConnections ? 'Connexions ‚úì' : 'Connexions' }}
            </button>
          </div>
        </div>
      </header>

      <!-- Grid Content -->
      <div class="flex-1 overflow-y-auto p-8 bg-gray-50">
        <div v-if="loading" class="flex flex-col items-center justify-center h-full">
          <div class="loader"></div>
          <p class="text-gray-500 text-sm">Chargement depuis GitHub...</p>
        </div>

        <div v-else-if="filteredFiles.length === 0" class="text-center text-gray-400 mt-20">
          Aucun fichier trouv√© pour ce dossier.
        </div>

        <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- CARD COMPONENT -->
          <div v-for="file in filteredFiles" :key="file.path" @click="openFile(file)" class="bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow cursor-pointer border border-gray-100 overflow-hidden flex flex-col">
            <!-- Card Header (Type Badge) -->
            <div class="h-2 w-full" :class="getTypeColor(file.metadata.type)"></div>
            
            <div class="p-5 flex-1 flex flex-col">
              <span class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-2">
                {{ file.metadata.type || 'Document' }}
              </span>
              
              <h3 class="text-xl font-bold text-primary mb-2 line-clamp-2">
                {{ file.metadata.title || file.name }}
              </h3>
              
              <p class="text-sm text-gray-500 line-clamp-3 mb-3">
                {{ file.metadata.summary || 'Cliquez pour voir le contenu...' }}
              </p>
              
              <!-- Metadata Section -->
              <div v-if="showMetadata" class="mt-auto pt-3 border-t border-gray-100 space-y-2">
                <div v-if="file.metadata.occupation" class="text-xs text-gray-600">
                  <span class="font-semibold">Fonction:</span> {{ file.metadata.occupation }}
                </div>
                <div v-if="file.metadata.birth_date" class="text-xs text-gray-600">
                  <span class="font-semibold">N√©(e) le:</span> {{ formatDate(file.metadata.birth_date) }}
                </div>
                <div v-if="file.metadata.founded" class="text-xs text-gray-600">
                  <span class="font-semibold">Fond√© en:</span> {{ file.metadata.founded }}
                </div>
                <div v-if="Array.isArray(file.metadata.keywords) && file.metadata.keywords.length > 0" class="flex flex-wrap gap-1">
                  <span v-for="keyword in file.metadata.keywords.slice(0, 3)" :key="keyword" class="keyword-tag">
                    {{ keyword }}
                  </span>
                </div>
              </div>
              
              <!-- Connections Preview -->
              <div v-if="showConnections && file.connections && file.connections.length > 0" class="mt-auto pt-3 border-t border-gray-100">
                <div class="text-xs font-semibold text-gray-600 mb-1">üîó Connexions:</div>
                <div class="text-xs text-gray-500">
                  {{ file.connections.length }} lien(s) - {{ file.connections.slice(0, 2).join(', ') }}{{ file.connections.length > 2 ? '...' : '' }}
                </div>
              </div>
            </div>
            
            <div class="px-5 py-3 bg-gray-50 border-t border-gray-100 flex justify-between items-center">
              <span class="text-xs text-gray-400">MD File</span>
              <span class="text-xs font-semibold text-secondary">Lire ‚Üí</span>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL (Overlay) -->
      <div v-if="activeFile" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4" @click.self="closeModal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col overflow-hidden animate-fade-in">
          
          <!-- Modal Header -->
          <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-start bg-gray-50">
            <div class="flex-1">
              <span class="px-2 py-1 rounded text-xs font-bold text-white uppercase" :class="getTypeBgColor(activeFile.metadata.type)">
                {{ activeFile.metadata.type }}
              </span>
              <h2 class="text-3xl font-bold text-primary mt-3">{{ activeFile.metadata.title || activeFile.name }}</h2>
              <p v-if="activeFile.metadata.summary" class="text-gray-500 italic mt-1">{{ activeFile.metadata.summary }}</p>
              
              <!-- Metadata Grid -->
              <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                <div v-if="activeFile.metadata.occupation" class="text-gray-600">
                  <span class="font-semibold">Fonction:</span> {{ activeFile.metadata.occupation }}
                </div>
                <div v-if="activeFile.metadata.birth_date" class="text-gray-600">
                  <span class="font-semibold">N√©(e) le:</span> {{ formatDate(activeFile.metadata.birth_date) }}
                </div>
                <div v-if="activeFile.metadata.birth_place" class="text-gray-600">
                  <span class="font-semibold">Lieu:</span> {{ activeFile.metadata.birth_place }}
                </div>
                <div v-if="activeFile.metadata.nationality" class="text-gray-600">
                  <span class="font-semibold">Nationalit√©:</span> {{ activeFile.metadata.nationality }}
                </div>
                <div v-if="activeFile.metadata.founded" class="text-gray-600">
                  <span class="font-semibold">Fond√© en:</span> {{ activeFile.metadata.founded }}
                </div>
                <div v-if="activeFile.metadata.headquarters" class="text-gray-600">
                  <span class="font-semibold">Si√®ge:</span> {{ activeFile.metadata.headquarters }}
                </div>
                <div v-if="activeFile.metadata.industry" class="text-gray-600 col-span-2">
                  <span class="font-semibold">Industrie:</span> {{ activeFile.metadata.industry }}
                </div>
              </div>
              
              <!-- Keywords -->
              <div v-if="Array.isArray(activeFile.metadata.keywords) && activeFile.metadata.keywords.length > 0" class="mt-3">
                <span class="text-xs font-semibold text-gray-600 mr-2">Mots-cl√©s:</span>
                <span v-for="keyword in activeFile.metadata.keywords" :key="keyword" class="keyword-tag">
                  {{ keyword }}
                </span>
              </div>
              
              <!-- Connections -->
              <div v-if="activeFile.connections && activeFile.connections.length > 0" class="mt-3">
                <span class="text-xs font-semibold text-gray-600 block mb-1">üîó Connexions ({{ activeFile.connections.length }}):</span>
                <div class="flex flex-wrap gap-2">
                  <span v-for="conn in activeFile.connections.slice(0, 10)" :key="conn" @click.stop="searchAndOpen(conn)" class="connection-link text-xs">
                    {{ conn }}
                  </span>
                  <span v-if="activeFile.connections.length > 10" class="text-xs text-gray-400">
                    +{{ activeFile.connections.length - 10 }} autres...
                  </span>
                </div>
              </div>
            </div>
            <button @click="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl font-light ml-4">&times;</button>
          </div>

          <!-- Modal Body (Markdown Content) -->
          <div class="flex-1 overflow-y-auto p-8 bg-white">
            <div class="markdown-body max-w-none" v-html="compiledMarkdown"></div>
          </div>
          
          <!-- Modal Footer -->
          <div class="px-8 py-4 bg-gray-50 border-t border-gray-100 flex justify-end space-x-3">
             <a :href="`https://github.com/oiIOIioiI0IioiIOIio/french-connexion/blob/main/${activeFile.path}`" target="_blank" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
               Voir sur GitHub
             </a>
             <button @click="closeModal" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-slate-700">
               Fermer
             </button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- VUE JS APP LOGIC -->
  <script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
      setup() {
        // Liste exacte des dossiers dans votre repo
        const folders = ['personnes', 'institutions', 'companies', 'medias', 'think tanks', '√©coles'];
        const selectedFolder = ref(null);
        const searchQuery = ref('');
        const allFiles = ref([]); 
        const loading = ref(false);
        const activeFile = ref(null);
        const sortBy = ref('name');
        const showMetadata = ref(true);
        const showConnections = ref(true);
        
        onMounted(() => {
          loadAllContent();
        });

        const loadAllContent = async () => {
          loading.value = true;
          try {
            // On charge les dossiers en parall√®le pour aller plus vite
            const promises = folders.map(folder => fetchFiles(folder));
            const results = await Promise.all(promises);
            // On aplatit la liste de listes
            allFiles.value = results.flat();
            console.log(`Charg√© ${allFiles.value.length} fiches.`);
          } catch (e) {
            console.error("Erreur critique:", e);
            alert("Erreur lors du chargement des donn√©es. V√©rifiez la console.");
          } finally {
            loading.value = false;
          }
        };

        const fetchFiles = async (folder) => {
          try {
            // 1. R√©cup√©rer la liste des fichiers via l'API GitHub
            const apiUrl = `https://api.github.com/repos/oiIOIioiI0IioiIOIio/french-connexion/contents/${folder}?ref=main`;
            const response = await fetch(apiUrl);
            if (!response.ok) return []; // Dossier introuvable ou erreur
            
            const data = await response.json();
            
            // 2. Pour chaque fichier MD, on va chercher le CONTENU BRUT
            const filePromises = data
              .filter(item => item.type === 'file' && item.name.endsWith('.md'))
              .map(async (item) => {
                try {
                  // Utilisation de raw.githubusercontent.com pour avoir le texte direct (plus simple que du base64)
                  const rawUrl = `https://raw.githubusercontent.com/oiIOIioiI0IioiIOIio/french-connexion/main/${item.path}`;
                  const rawResponse = await fetch(rawUrl);
                  
                  if (!rawResponse.ok) return null;
                  
                  const content = await rawResponse.text();
                  const metadata = parseFrontmatter(content);
                  const connections = extractConnections(content);
                  
                  return {
                    path: item.path,
                    name: item.name.replace('.md', ''),
                    metadata: metadata,
                    rawContent: content,
                    connections: connections
                  };
                } catch (err) {
                  console.error(`Erreur lecture ${item.name}:`, err);
                  return null;
                }
              });
              
            const files = await Promise.all(filePromises);
            return files.filter(f => f !== null);
            
          } catch (e) {
            console.error(`Erreur dossier ${folder}:`, e);
            return [];
          }
        };

        // Parser le Frontmatter (R√©sistant aux erreurs)
        const parseFrontmatter = (content) => {
          try {
            const parts = content.split('---');
            if (parts.length < 3) return {}; // Pas de frontmatter
            
            const frontmatterText = parts[1];
            const metadata = {};
            
            const lines = frontmatterText.split('\n');
            let currentKey = null;
            let currentArray = [];
            
            for (let line of lines) {
              // Check if it's an array item
              if (line.trim().startsWith('- ') && currentKey) {
                currentArray.push(line.trim().substring(2));
                continue;
              }
              
              // If we were building an array, save it
              if (currentKey && currentArray.length > 0) {
                metadata[currentKey] = currentArray;
                currentArray = [];
                currentKey = null;
              }
              
              // Parse key: value
              const colonIndex = line.indexOf(':');
              if (colonIndex > -1) {
                const key = line.substring(0, colonIndex).trim();
                let value = line.substring(colonIndex + 1).trim();
                
                // If value is empty, might be start of array
                if (value === '' || value === 'null') {
                  currentKey = key;
                  if (value === 'null') {
                    metadata[key] = null;
                    currentKey = null;
                  }
                } else {
                  // Retire les guillemets si pr√©sents
                  if ((value.startsWith('"') && value.endsWith('"')) || (value.startsWith("'") && value.endsWith("'"))) {
                    value = value.slice(1, -1);
                  }
                  metadata[key] = value;
                }
              }
            }
            
            // Save last array if exists
            if (currentKey && currentArray.length > 0) {
              metadata[currentKey] = currentArray;
            }
            
            return metadata;
          } catch (e) {
            console.error('Error parsing frontmatter:', e);
            return {};
          }
        };
        
        // Extract wiki-style connections [[name]]
        const extractConnections = (content) => {
          const regex = /\[\[([^\]]+)\]\]/g;
          const connections = [];
          let match;
          
          while ((match = regex.exec(content)) !== null) {
            const conn = match[1].trim();
            if (!connections.includes(conn)) {
              connections.push(conn);
            }
          }
          
          return connections;
        };

        const filteredFiles = computed(() => {
          let files = allFiles.value;
          
          if (selectedFolder.value) {
            files = files.filter(f => f.path.startsWith(selectedFolder.value));
          }
          
          if (searchQuery.value) {
            const q = searchQuery.value.toLowerCase();
            files = files.filter(f => 
              f.name.toLowerCase().includes(q) || 
              (f.metadata.summary && f.metadata.summary.toLowerCase().includes(q)) ||
              (f.metadata.type && f.metadata.type.toLowerCase().includes(q)) ||
              (Array.isArray(f.metadata.keywords) && f.metadata.keywords.some(k => k.toLowerCase().includes(q)))
            );
          }
          
          // Sorting
          if (sortBy.value === 'name') {
            files = [...files].sort((a, b) => (a.metadata.title || a.name).localeCompare(b.metadata.title || b.name));
          } else if (sortBy.value === 'name-desc') {
            files = [...files].sort((a, b) => (b.metadata.title || b.name).localeCompare(a.metadata.title || a.name));
          } else if (sortBy.value === 'type') {
            files = [...files].sort((a, b) => (a.metadata.type || '').localeCompare(b.metadata.type || ''));
          } else if (sortBy.value === 'date') {
            files = [...files].sort((a, b) => {
              const dateA = a.metadata.birth_date || a.metadata.founded || '0000';
              const dateB = b.metadata.birth_date || b.metadata.founded || '0000';
              return dateB.localeCompare(dateA);
            });
          }
          
          return files;
        });

        const loadFolder = (folder) => {
          selectedFolder.value = folder;
        };
        
        const formatFolderName = (f) => f.replace('think tanks', 'Think Tanks');
        
        const getTypeColor = (type) => {
          const map = {
            'Personne': 'bg-blue-500',
            'Institution': 'bg-purple-500',
            'Entreprise': 'bg-orange-500',
            'Media': 'bg-red-500',
            'Ecole': 'bg-green-500',
            'Think Tank': 'bg-teal-500'
          };
          return map[type] || 'bg-gray-400';
        };
        
        const getTypeBgColor = (type) => {
           const map = {
            'Personne': 'bg-blue-500',
            'Institution': 'bg-purple-500',
            'Entreprise': 'bg-orange-500',
            'Media': 'bg-red-500',
            'Ecole': 'bg-green-500',
            'Think Tank': 'bg-teal-500'
          };
          return map[type] || 'bg-gray-400';
        };

        const openFile = (file) => {
          activeFile.value = file;
        };
        
        const closeModal = () => {
          activeFile.value = null;
        };

        const compiledMarkdown = computed(() => {
          if (!activeFile.value) return '';
          // On nettoie le frontmatter pour l'affichage
          const split = activeFile.value.rawContent.split('---');
          const body = split.length > 2 ? split.slice(2).join('---') : split.slice(1).join('---');
          return marked.parse(body);
        });
        
        const formatDate = (dateStr) => {
          if (!dateStr) return '';
          try {
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
          } catch {
            return dateStr;
          }
        };
        
        const searchAndOpen = (name) => {
          const file = allFiles.value.find(f => 
            (f.metadata.title && f.metadata.title === name) || 
            f.name === name
          );
          if (file) {
            openFile(file);
          } else {
            alert(`Fichier "${name}" non trouv√©`);
          }
        };

        return {
          folders,
          selectedFolder,
          loadFolder,
          searchQuery,
          filteredFiles,
          loading,
          activeFile,
          openFile,
          closeModal,
          compiledMarkdown,
          formatFolderName,
          getTypeColor,
          getTypeBgColor,
          sortBy,
          showMetadata,
          showConnections,
          formatDate,
          searchAndOpen
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
