<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>French Connexion</title>
  
  <!-- 1. Framework CSS Moderne (Tailwind) pour le design "Forestry" -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. Vue.js 3 pour la logique dynamique -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  
  <!-- 3. Marked pour convertir le Markdown en HTML -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- 4. Configuration Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#2c3e50',
            secondary: '#42b983',
            background: '#f8fafc',
            surface: '#ffffff'
          }
        }
      }
    }
  </script>
  
  <style>
    /* Styles personnels pour le markdown rendu */
    .markdown-body h1 { font-size: 1.8em; font-weight: bold; margin-bottom: 0.5em; color: #1a202c; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.3em; }
    .markdown-body h2 { font-size: 1.5em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #2d3748; }
    .markdown-body p { margin-bottom: 1em; line-height: 1.6; color: #4a5568; }
    .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
    .markdown-body a { color: #3182ce; text-decoration: underline; }
    .markdown-body strong { color: #1a202c; }
    
    /* Loader animation */
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #42b983; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-background text-slate-800 h-screen overflow-hidden">

  <div id="app" class="flex h-full">
    
    <!-- SIDEBAR -->
    <aside class="w-64 bg-surface border-r border-gray-200 flex flex-col shadow-sm z-10">
      <div class="p-6 border-b border-gray-100">
        <h1 class="text-2xl font-bold text-primary">French Connexion</h1>
        <p class="text-xs text-gray-500 mt-1">Base de donn√©es interactive</p>
      </div>

      <nav class="flex-1 overflow-y-auto p-4 space-y-2">
        <button @click="loadFolder(null)" :class="{'bg-primary text-white': !selectedFolder, 'text-gray-600 hover:bg-gray-100': selectedFolder}" class="w-full text-left px-4 py-2 rounded-lg transition-colors font-medium">
          üìÇ Toutes les fiches
        </button>
        
        <div v-for="folder in folders" :key="folder">
          <button @click="loadFolder(folder)" :class="{'bg-primary text-white': selectedFolder === folder, 'text-gray-600 hover:bg-gray-100': selectedFolder !== folder}" class="w-full text-left px-4 py-2 rounded-lg transition-colors text-sm capitalize">
            {{ formatFolderName(folder) }}
          </button>
        </div>
      </nav>
      
      <div class="p-4 border-t border-gray-100 text-xs text-center text-gray-400">
        Powered by GitHub API
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
      
      <!-- Header / Search -->
      <header class="h-16 bg-surface border-b border-gray-200 flex items-center justify-between px-8 shadow-sm">
        <h2 class="text-lg font-semibold text-gray-700">
          {{ selectedFolder ? formatFolderName(selectedFolder) : 'Vue d\'ensemble' }} 
          <span class="text-sm font-normal text-gray-400 ml-2">({{ filteredFiles.length }} fiches)</span>
        </h2>
        
        <div class="relative w-64">
          <input v-model="searchQuery" type="text" placeholder="Rechercher..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent text-sm">
          <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
        </div>
      </header>

      <!-- Grid Content -->
      <div class="flex-1 overflow-y-auto p-8 bg-gray-50">
        <div v-if="loading" class="flex flex-col items-center justify-center h-full">
          <div class="loader"></div>
          <p class="text-gray-500 text-sm">Chargement depuis GitHub...</p>
        </div>

        <div v-else-if="filteredFiles.length === 0" class="text-center text-gray-400 mt-20">
          Aucun fichier trouv√©.
        </div>

        <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- CARD COMPONENT -->
          <div v-for="file in filteredFiles" :key="file.path" @click="openFile(file)" class="bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow cursor-pointer border border-gray-100 overflow-hidden flex flex-col h-64">
            <!-- Card Header (Type Badge) -->
            <div class="h-2 w-full" :class="getTypeColor(file.metadata.type)"></div>
            
            <div class="p-5 flex-1 flex flex-col">
              <span class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-2">
                {{ file.metadata.type || 'Fichier' }}
              </span>
              
              <h3 class="text-xl font-bold text-primary mb-2 line-clamp-2">
                {{ file.metadata.title || file.name }}
              </h3>
              
              <p class="text-sm text-gray-500 line-clamp-3 mt-auto">
                {{ file.metadata.summary || 'Aucun r√©sum√© disponible...' }}
              </p>
            </div>
            
            <div class="px-5 py-3 bg-gray-50 border-t border-gray-100 flex justify-between items-center">
              <span class="text-xs text-gray-400">{{ new Date(file.modified).toLocaleDateString() }}</span>
              <span class="text-xs font-semibold text-secondary">Lire la fiche ‚Üí</span>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL (Overlay) -->
      <div v-if="activeFile" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4" @click.self="closeModal">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col overflow-hidden animate-fade-in">
          
          <!-- Modal Header -->
          <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-start bg-gray-50">
            <div>
              <span class="px-2 py-1 rounded text-xs font-bold text-white uppercase" :class="getTypeBgColor(activeFile.metadata.type)">
                {{ activeFile.metadata.type }}
              </span>
              <h2 class="text-3xl font-bold text-primary mt-3">{{ activeFile.metadata.title }}</h2>
              <p v-if="activeFile.metadata.summary" class="text-gray-500 italic mt-1">{{ activeFile.metadata.summary }}</p>
            </div>
            <button @click="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl font-light">&times;</button>
          </div>

          <!-- Modal Body (Markdown Content) -->
          <div class="flex-1 overflow-y-auto p-8 bg-white">
            <div class="markdown-body max-w-none" v-html="compiledMarkdown"></div>
          </div>
          
          <!-- Modal Footer -->
          <div class="px-8 py-4 bg-gray-50 border-t border-gray-100 flex justify-end space-x-3">
             <a :href="`https://github.com/oiIOIioiI0IioiIOIio/french-connexion/blob/main/${activeFile.path}`" target="_blank" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
               Voir sur GitHub
             </a>
             <button @click="closeModal" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-slate-700">
               Fermer
             </button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- VUE JS APP LOGIC -->
  <script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
      setup() {
        const folders = ['personnes', 'institutions', 'companies', 'medias', 'think tanks', '√©coles'];
        const selectedFolder = ref(null);
        const searchQuery = ref('');
        const allFiles = ref([]); // Stockage global
        const loading = ref(false);
        const activeFile = ref(null);
        
        // Initialisation
        onMounted(() => {
          loadAllContent();
        });

        // Charger tout le contenu (Lazy load optimis√©)
        const loadAllContent = async () => {
          loading.value = true;
          try {
            const promises = folders.map(folder => fetchFiles(folder));
            const results = await Promise.all(promises);
            allFiles.value = results.flat();
          } catch (e) {
            console.error("Erreur de chargement", e);
          } finally {
            loading.value = false;
          }
        };

        // R√©cup√©rer fichiers d'un dossier via API GitHub
        const fetchFiles = async (folder) => {
          const response = await fetch(`https://api.github.com/repos/oiIOIioiI0IioiIOIio/french-connexion/${folder}?ref=main`);
          if (!response.ok) return [];
          const data = await response.json();
          
          // Pour chaque fichier, on r√©cup√®re le contenu (d√©codage base64)
          const filePromises = data.filter(item => item.type === 'file' && item.name.endsWith('.md')).map(async item => {
            try {
              // On utilise l'URL raw ou on d√©code le content fourni par l'API si < 1MB
              const content = atob(item.content); // D√©codage Base64
              const metadata = parseFrontmatter(content);
              return {
                path: item.path,
                name: item.name.replace('.md', ''),
                modified: new Date(), // L'API ne donne pas toujours la date modifi√©e facilement dans l'endpoint contents
                metadata: metadata,
                rawContent: content
              };
            } catch (err) {
              return null;
            }
          });
          
          return (await Promise.all(filePromises)).filter(f => f !== null);
        };

        // Parser le Frontmatter simple (ex: Title: ...)
        const parseFrontmatter = (content) => {
          const lines = content.split('\n');
          const metadata = {};
          let frontmatterActive = false;
          
          for (let line of lines) {
            if (line.trim() === '---') {
              frontmatterActive = !frontmatterActive;
              continue;
            }
            if (frontmatterActive) {
              const [key, ...valParts] = line.split(':');
              if (key && valParts.length) {
                metadata[key.trim()] = valParts.join(':').trim().replace(/^"|"$/g, '').replace(/^'|'$/g, '');
              }
            }
          }
          return metadata;
        };

        // Computed pour filtrer
        const filteredFiles = computed(() => {
          let files = allFiles.value;
          
          // Filtre Dossier
          if (selectedFolder.value) {
            files = files.filter(f => f.path.startsWith(selectedFolder.value));
          }
          
          // Filtre Recherche
          if (searchQuery.value) {
            const q = searchQuery.value.toLowerCase();
            files = files.filter(f => 
              f.name.toLowerCase().includes(q) || 
              (f.metadata.summary && f.metadata.summary.toLowerCase().includes(q))
            );
          }
          
          return files;
        });

        // Helpers
        const loadFolder = (folder) => {
          selectedFolder.value = folder;
        };
        
        const formatFolderName = (f) => f.replace('think tanks', 'Think Tanks');
        
        const getTypeColor = (type) => {
          const map = {
            'Personne': 'bg-blue-500',
            'Institution': 'bg-purple-500',
            'Entreprise': 'bg-orange-500',
            'Media': 'bg-red-500',
            'Ecole': 'bg-green-500',
            'Think Tank': 'bg-teal-500'
          };
          return map[type] || 'bg-gray-400';
        };
        
        const getTypeBgColor = (type) => {
           const map = {
            'Personne': 'bg-blue-500',
            'Institution': 'bg-purple-500',
            'Entreprise': 'bg-orange-500',
            'Media': 'bg-red-500',
            'Ecole': 'bg-green-500',
            'Think Tank': 'bg-teal-500'
          };
          return map[type] || 'bg-gray-400';
        };

        // Modal Logic
        const openFile = (file) => {
          activeFile.value = file;
        };
        
        const closeModal = () => {
          activeFile.value = null;
        };

        const compiledMarkdown = computed(() => {
          if (!activeFile.value) return '';
          // On enl√®ve le frontmatter pour l'affichage markdown
          const split = activeFile.value.rawContent.split('---');
          // Si y'a 3 parties (start---, content---, end) on prend la 3√®me. Si seulement 2, on prend la fin.
          const body = split.length > 2 ? split.slice(2).join('---') : split.slice(1).join('---');
          return marked.parse(body);
        });

        return {
          folders,
          selectedFolder,
          loadFolder,
          searchQuery,
          filteredFiles,
          loading,
          activeFile,
          openFile,
          closeModal,
          compiledMarkdown,
          formatFolderName,
          getTypeColor,
          getTypeBgColor
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
